<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I-Stein Super Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes typing {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        .typing-dot { animation: typing 1.4s infinite; }
        .listening-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">âš™ï¸ Super Powered Settings</h2>
                    <button onclick="closeSettings()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>

                <!-- AI Mode -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">AI Mode</label>
                    <select id="aiMode" onchange="toggleAISettings()" class="w-full px-4 py-2 border rounded-lg">
                        <option value="rules">ğŸ”§ Rule-Based (Free, Offline)</option>
                        <option value="gemini">âœ¨ Google Gemini (Free!)</option>
                        <option value="openai">ğŸ¤– OpenAI ChatGPT</option>
                    </select>
                </div>

                <div id="geminiSettings" class="hidden mb-4 p-4 bg-green-50 rounded-lg border-2 border-green-200">
                    <h3 class="font-semibold mb-2">âœ¨ Google Gemini</h3>
                    <input type="password" id="geminiKey" placeholder="AIzaSy..." class="w-full px-4 py-2 border rounded-lg mb-2"/>
                    <p class="text-xs text-gray-600">Get FREE key: <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-600 underline">Google AI Studio</a></p>
                </div>

                <div id="openaiSettings" class="hidden mb-4 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                    <h3 class="font-semibold mb-2">ğŸ¤– OpenAI</h3>
                    <input type="password" id="openaiKey" placeholder="sk-proj-..." class="w-full px-4 py-2 border rounded-lg mb-2"/>
                </div>

                <!-- API Keys for Internet Features -->
                <div class="mb-4 p-4 bg-yellow-50 rounded-lg border-2 border-yellow-200">
                    <h3 class="font-semibold mb-3">ğŸŒ Internet Features (Optional)</h3>
                    
                    <label class="block text-sm font-medium mb-1">Weather API Key (OpenWeather):</label>
                    <input type="password" id="weatherKey" placeholder="Optional - Get free at openweathermap.org" class="w-full px-4 py-2 border rounded-lg mb-3 text-sm"/>
                    
                    <label class="block text-sm font-medium mb-1">News API Key (NewsAPI):</label>
                    <input type="password" id="newsKey" placeholder="Optional - Get free at newsapi.org" class="w-full px-4 py-2 border rounded-lg mb-3 text-sm"/>
                    
                    <div class="text-xs text-gray-600 bg-white p-3 rounded">
                        <strong>ğŸ“ Note:</strong> Search & Wikipedia work without keys! Weather & News need free API keys (optional).
                        <br><br>
                        <strong>Get free keys:</strong><br>
                        â€¢ Weather: <a href="https://openweathermap.org/api" target="_blank" class="text-blue-600 underline">openweathermap.org</a> (1000 calls/day free)<br>
                        â€¢ News: <a href="https://newsapi.org" target="_blank" class="text-blue-600 underline">newsapi.org</a> (100 calls/day free)
                    </div>
                </div>

                <!-- Voice Settings -->
                <div class="mb-4 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                    <h3 class="font-semibold mb-3">ğŸ¤ Voice</h3>
                    <label class="flex items-center gap-2 mb-3">
                        <input type="checkbox" id="continuousListen" class="w-4 h-4"/>
                        <span class="text-sm font-medium">ğŸ™ï¸ Always Listen</span>
                    </label>
                    <label class="flex items-center gap-2 mb-3">
                        <input type="checkbox" id="autoSpeak" class="w-4 h-4"/>
                        <span class="text-sm font-medium">Auto-speak responses</span>
                    </label>
                    <label class="block text-sm mb-1">Voice #: <input type="number" id="voiceNum" min="0" max="21" value="5" class="w-20 px-2 py-1 border rounded"/></label>
                    <label class="block text-sm mb-1">Speed: <span id="speedVal">1.3</span>x</label>
                    <input type="range" id="voiceSpeed" min="0.5" max="2" step="0.1" value="1.3" class="w-full mb-2" oninput="document.getElementById('speedVal').textContent = this.value"/>
                </div>

                <!-- Personality -->
                <div class="mb-4 p-4 bg-pink-50 rounded-lg border-2 border-pink-200">
                    <h3 class="font-semibold mb-3">ğŸ˜Š Personality</h3>
                    <label class="block text-sm mb-1">Your Name:</label>
                    <input type="text" id="userName" placeholder="Optional" class="w-full px-4 py-2 border rounded-lg mb-3"/>
                    <label class="block text-sm mb-1">Style:</label>
                    <select id="personality" class="w-full px-4 py-2 border rounded-lg">
                        <option value="friendly">ğŸ˜Š Friendly</option>
                        <option value="professional">ğŸ’¼ Professional</option>
                        <option value="funny">ğŸ˜‚ Funny</option>
                        <option value="motivational">ğŸ’ª Motivational</option>
                    </select>
                </div>

                <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 font-medium">ğŸ’¾ Save All Settings</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="flex flex-col h-screen">
        <!-- Header -->
        <div class="bg-white shadow-md px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-2 rounded-full relative">
                    <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="2" fill="white"/>
                        <circle cx="12" cy="12" r="8" stroke="white" stroke-width="2" fill="none"/>
                        <path d="M12 2v4m0 12v4m10-10h-4m-12 0H2" stroke="white" stroke-width="2"/>
                    </svg>
                    <span id="listeningIndicator" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full listening-pulse"></span>
                </div>
                <div>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">I-Stein âš¡ Super Powered</h1>
                    <p class="text-xs text-gray-500" id="statusText">Ready with internet access!</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="showCommands()" class="p-2 hover:bg-gray-100 rounded-full" title="Commands">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </button>
                <button onclick="openSettings()" class="p-2 hover:bg-gray-100 rounded-full" title="Settings">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </button>
                <button onclick="clearChat()" class="p-2 hover:bg-gray-100 rounded-full" title="Clear">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Messages -->
        <div id="messages" class="flex-1 overflow-y-auto px-4 py-4 space-y-3">
            <div class="text-center text-gray-500 mt-20">
                <div class="text-6xl mb-4">ğŸš€âš¡</div>
                <p class="text-lg font-medium" id="welcomeMsg">I'm I-Stein Super Powered!</p>
                <p class="text-sm mt-2">Now with internet search, weather, news & more!</p>
                <div class="mt-4 flex gap-2 justify-center flex-wrap">
                    <button onclick="quickAction('/search latest AI news')" class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow rounded-full text-sm hover:shadow-lg">ğŸ” Search</button>
                    <button onclick="quickAction('/weather New York')" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow rounded-full text-sm hover:shadow-lg">ğŸŒ¤ï¸ Weather</button>
                    <button onclick="quickAction('/help')" class="px-4 py-2 bg-white shadow rounded-full text-sm hover:bg-gray-50">ğŸ“š Commands</button>
                </div>
            </div>
        </div>

        <!-- Input -->
        <div class="bg-white border-t px-4 py-3">
            <div class="flex gap-2 max-w-4xl mx-auto">
                <button onclick="toggleContinuousListen()" id="voiceBtn" class="bg-red-500 text-white p-3 rounded-full hover:bg-red-600" title="Toggle Always Listen">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                </button>
                <input type="text" id="input" placeholder="Ask anything or use /commands..." class="flex-1 px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500" onkeypress="if(event.key==='Enter')send()"/>
                <button onclick="send()" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-3 rounded-full hover:shadow-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        let messages = [];
        let config = {
            mode: 'rules',
            geminiKey: '',
            openaiKey: '',
            weatherKey: '',
            newsKey: '',
            autoSpeak: false,
            continuousListen: false,
            voiceSpeed: 1.3,
            voiceNum: 5,
            userName: '',
            personality: 'friendly'
        };
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let isListening = false;
        let notes = [];
        let todos = [];

        window.onload = () => {
            loadConfig();
            loadMessages();
            initVoice();
            greetUser();
        };

        function greetUser() {
            if (config.userName) {
                document.getElementById('welcomeMsg').textContent = `Hello ${config.userName}! I'm Super Powered! ğŸš€`;
                document.getElementById('statusText').textContent = `Hey ${config.userName}! Internet ready!`;
            }
        }

        function initVoice() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = false;
                
                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('listeningIndicator').classList.remove('hidden');
                    document.getElementById('voiceBtn').classList.add('bg-green-500');
                    document.getElementById('voiceBtn').classList.remove('bg-red-500');
                };
                
                recognition.onend = () => {
                    isListening = false;
                    document.getElementById('listeningIndicator').classList.add('hidden');
                    document.getElementById('voiceBtn').classList.remove('bg-green-500');
                    document.getElementById('voiceBtn').classList.add('bg-red-500');
                    if (config.continuousListen) {
                        setTimeout(() => recognition.start(), 500);
                    }
                };
                
                recognition.onresult = (event) => {
                    const text = event.results[event.results.length - 1][0].transcript;
                    document.getElementById('input').value = text;
                    setTimeout(() => send(), 300);
                };
                
                recognition.onerror = (error) => {
                    if (error.error !== 'no-speech') {
                        isListening = false;
                        document.getElementById('listeningIndicator').classList.add('hidden');
                    }
                };
            } else {
                document.getElementById('voiceBtn').style.display = 'none';
            }
        }

        function toggleContinuousListen() {
            config.continuousListen = !config.continuousListen;
            saveConfig();
            if (config.continuousListen) {
                recognition.start();
                showToast('ğŸ™ï¸ Always listening ON!');
            } else {
                recognition.stop();
                showToast('ğŸ™ï¸ Manual mode.');
            }
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-20 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg slide-in z-50';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function quickAction(text) {
            document.getElementById('input').value = text;
            send();
        }

        function speak(text) {
            if (!config.autoSpeak) return;
            synthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = config.voiceSpeed;
            const voices = synthesis.getVoices();
            if (voices[config.voiceNum]) {
                utterance.voice = voices[config.voiceNum];
            }
            synthesis.speak(utterance);
        }

        function send() {
            const input = document.getElementById('input');
            const text = input.value.trim();
            if (!text) return;
            
            if (text.startsWith('/')) {
                handleCommand(text);
                input.value = '';
                return;
            }
            
            addMessage(text, 'user');
            input.value = '';
            showTyping();
            
            setTimeout(async () => {
                hideTyping();
                try {
                    const response = await getAIResponse(text);
                    addMessage(response, 'bot', getQuickReplies(response));
                    speak(response);
                } catch (error) {
                    addMessage('Error: ' + error.message, 'bot');
                }
            }, 800);
        }

        async function handleCommand(cmd) {
            const parts = cmd.split(' ');
            const command = parts[0].toLowerCase();
            const args = parts.slice(1).join(' ');
            
            showTyping();
            
            try {
                switch(command) {
                    case '/help':
                        hideTyping();
                        addMessage(`ğŸš€ **I-Stein Super Powered Commands:**

**ğŸ” Internet & Search:**
â€¢ /search [query] - Web search
â€¢ /wiki [topic] - Wikipedia lookup
â€¢ /news [topic] - Latest news
â€¢ /weather [city] - Weather forecast
â€¢ /currency [amt] [from] to [to] - Convert (e.g., /currency 100 USD to EUR)
â€¢ /define [word] - Dictionary
â€¢ /translate [text] to [lang] - Translate

**ğŸ› ï¸ Tools:**
â€¢ /calc [expression] - Calculator
â€¢ /time [city] - Time in city
â€¢ /note [text] - Save note
â€¢ /notes - View notes
â€¢ /todo [task] - Add to-do
â€¢ /todos - View to-dos

**ğŸ‰ Fun:**
â€¢ /joke - Random joke
â€¢ /fact - Interesting fact
â€¢ /motivate - Motivation
â€¢ /clear - Clear chat`, 'bot');
                        break;
                        
                    case '/search':
                        if (!args) {
                            hideTyping();
                            addMessage('Usage: /search your query here', 'bot');
                            return;
                        }
                        const searchResults = await webSearch(args);
                        hideTyping();
                        addMessage(searchResults, 'bot', ['Search more', 'Thanks!']);
                        break;
                        
                    case '/wiki':
                        if (!args) {
                            hideTyping();
                            addMessage('Usage: /wiki topic', 'bot');
                            return;
                        }
                        const wikiResult = await searchWikipedia(args);
                        hideTyping();
                        addMessage(wikiResult, 'bot', ['Tell me more', 'Thanks!']);
                        break;
                        
                    case '/weather':
                        if (!args) {
                            hideTyping();
                            addMessage('Usage: /weather city name', 'bot');
                            return;
                        }
                        const weatherData = await getWeather(args);
                        hideTyping();
                        addMessage(weatherData, 'bot');
                        break;
                        
                    case '/news':
                        const topic = args || 'latest';
                        const newsData = await getNews(topic);
                        hideTyping();
                        addMessage(newsData, 'bot');
                        break;
                        
                    case '/currency':
                        const currencyResult = await convertCurrency(args);
                        hideTyping();
                        addMessage(currencyResult, 'bot');
                        break;
                        
                    case '/define':
                        if (!args) {
                            hideTyping();
                            addMessage('Usage: /define word', 'bot');
                            return;
                        }
                        const definition = await getDefinition(args);
                        hideTyping();
                        addMessage(definition, 'bot');
                        break;
                        
                    case '/translate':
                        const translation = await translateText(args);
                        hideTyping();
                        addMessage(translation, 'bot');
                        break;
                        
                    case '/time':
                        const timeInfo = await getTimeIn(args || 'UTC');
                        hideTyping();
                        addMessage(timeInfo, 'bot');
                        break;
                        
                    case '/joke':
                        hideTyping();
                        const jokes = [
                            "Why don't scientists trust atoms? Because they make up everything! ğŸ˜„",
                            "Why did the scarecrow win an award? Outstanding in his field! ğŸŒ¾",
                            "What do you call a bear with no teeth? A gummy bear! ğŸ»",
                            "Parallel lines have so much in common. It's a shame they'll never meet! ğŸ“",
                            "I told my wife she was drawing her eyebrows too high. She looked surprised! ğŸ˜®"
                        ];
                        addMessage(jokes[Math.floor(Math.random() * jokes.length)], 'bot', ['Another!', 'Haha!']);
                        break;
                        
                    case '/fact':
                        hideTyping();
                        const facts = [
                            "ğŸŒ Honey never spoils! 3000-year-old honey is still edible.",
                            "ğŸ™ Octopuses have three hearts and blue blood!",
                            "âš¡ Lightning strikes Earth 100 times per second.",
                            "ğŸŒ™ All planets fit between Earth and Moon!",
                            "ğŸ¦ˆ Sharks are older than trees!"
                        ];
                        addMessage(facts[Math.floor(Math.random() * facts.length)], 'bot', ['Cool!', 'More facts']);
                        break;
                        
                    case '/motivate':
                        hideTyping();
                        const quotes = [
                            "ğŸ’ª You're capable of amazing things!",
                            "ğŸŒŸ Believe in yourself!",
                            "ğŸš€ Every expert was once a beginner!",
                            "âœ¨ Your potential is endless!",
                            "ğŸ¯ Success = small efforts repeated daily!"
                        ];
                        addMessage(quotes[Math.floor(Math.random() * quotes.length)], 'bot', ['Thanks!']);
                        break;
                        
                    case '/calc':
                        hideTyping();
                        try {
                            const result = eval(args);
                            addMessage(`ğŸ”¢ Result: **${result}**`, 'bot');
                        } catch(e) {
                            addMessage('âŒ Invalid. Example: /calc 5+3*2', 'bot');
                        }
                        break;
                        
                    case '/note':
                        hideTyping();
                        if (args) {
                            notes.push({text: args, time: new Date().toLocaleString()});
                            localStorage.setItem('notes', JSON.stringify(notes));
                            addMessage(`ğŸ“ Note saved! Total: ${notes.length}`, 'bot');
                        } else {
                            addMessage('Usage: /note your text', 'bot');
                        }
                        break;
                        
                    case '/notes':
                        hideTyping();
                        if (notes.length === 0) {
                            addMessage('ğŸ“ No notes yet!', 'bot');
                        } else {
                            let list = 'ğŸ“ **Your Notes:**\n\n';
                            notes.forEach((n, i) => {
                                list += `${i+1}. ${n.text}\n`;
                            });
                            addMessage(list, 'bot');
                        }
                        break;
                        
                    case '/todo':
                        hideTyping();
                        if (args) {
                            todos.push({task: args, done: false});
                            localStorage.setItem('todos', JSON.stringify(todos));
                            addMessage(`âœ… Added! Total: ${todos.length}`, 'bot');
                        } else {
                            addMessage('Usage: /todo your task', 'bot');
                        }
                        break;
                        
                    case '/todos':
                        hideTyping();
                        if (todos.length === 0) {
                            addMessage('âœ… No to-dos yet!', 'bot');
                        } else {
                            let list = 'âœ… **To-Dos:**\n\n';
                            todos.forEach((t, i) => {
                                list += `${i+1}. ${t.done ? 'âœ“' : 'â—‹'} ${t.task}\n`;
                            });
                            addMessage(list, 'bot');
                        }
                        break;
                        
                    case '/clear':
                        clearChat();
                        break;
                        
                    default:
                        hideTyping();
                        addMessage(`â“ Unknown: ${command}\nType /help`, 'bot');
                }
            } catch (error) {
                hideTyping();
                addMessage(`Error: ${error.message}`, 'bot');
            }
        }

        // Internet Functions
        async function webSearch(query) {
            try {
                // Using DuckDuckGo Instant Answer API (no key needed!)
                const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`);
                const data = await response.json();
                
                if (data.AbstractText) {
                    return `ğŸ” **Search Results:**\n\n**${data.Heading}**\n\n${data.AbstractText}\n\nğŸ“– Source: ${data.AbstractURL || 'DuckDuckGo'}`;
                } else if (data.RelatedTopics && data.RelatedTopics.length > 0) {
                    let results = 'ğŸ” **Search Results:**\n\n';
                    data.RelatedTopics.slice(0, 3).forEach((topic, i) => {
                        if (topic.Text) {
                            results += `${i+1}. ${topic.Text.substring(0, 150)}...\n\n`;
                        }
                    });
                    return results;
                } else {
                    return `ğŸ” Searched for: "${query}"\n\nNo detailed results found. Try being more specific or use /wiki for Wikipedia search.`;
                }
            } catch (error) {
                return 'âŒ Search failed. Check your internet connection.';
            }
        }

        async function searchWikipedia(topic) {
            try {
                const response = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(topic)}`);
                const data = await response.json();
                
                if (data.extract) {
                    return `ğŸ“š **Wikipedia: ${data.title}**\n\n${data.extract}\n\nğŸ”— Read more: ${data.content_urls?.desktop?.page || 'N/A'}`;
                } else {
                    return `ğŸ“š No Wikipedia article found for "${topic}". Try a different search term.`;
                }
            } catch (error) {
                return 'âŒ Wikipedia lookup failed. Check spelling or try /search instead.';
            }
        }

        async function getWeather(city) {
            if (!config.weatherKey) {
                return 'ğŸŒ¤ï¸ Weather API key not set.\n\nTo get weather:\n1. Get free key at openweathermap.org\n2. Add it in âš™ï¸ Settings\n3. Try again!\n\nFor now, search: /search weather in ' + city;
            }
            
            try {
                const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${config.weatherKey}&units=imperial`);
                const data = await response.json();
                
                if (data.main) {
                    const temp = Math.round(data.main.temp);
                    const feels = Math.round(data.main.feels_like);
                    const desc = data.weather[0].description;
                    const icon = data.weather[0].main;
                    
                    const icons = {
                        'Clear': 'â˜€ï¸',
                        'Clouds': 'â˜ï¸',
                        'Rain': 'ğŸŒ§ï¸',
                        'Snow': 'â„ï¸',
                        'Thunderstorm': 'â›ˆï¸'
                    };
                    
                    return `${icons[icon] || 'ğŸŒ¤ï¸'} **Weather in ${data.name}:**\n\nğŸŒ¡ï¸ Temperature: ${temp}Â°F (feels like ${feels}Â°F)\nâ˜ï¸ Conditions: ${desc}\nğŸ’¨ Wind: ${data.wind.speed} mph\nğŸ’§ Humidity: ${data.main.humidity}%`;
                } else {
                    return `ğŸŒ¤ï¸ City "${city}" not found. Try: /weather New York`;
                }
            } catch (error) {
                return 'âŒ Weather service error. Check your API key in settings.';
            }
        }

        async function getNews(topic) {
            if (!config.newsKey) {
                return 'ğŸ“° News API key not set.\n\nTo get news:\n1. Get free key at newsapi.org\n2. Add it in âš™ï¸ Settings\n3. Try again!\n\nFor now, try: /search latest ' + topic + ' news';
            }
            
            try {
                const query = topic === 'latest' ? 'technology' : topic;
                const response = await fetch(`https://newsapi.org/v2/everything?q=${encodeURIComponent(query)}&sortBy=publishedAt&pageSize=5&apiKey=${config.newsKey}`);
                const data = await response.json();
                
                if (data.articles && data.articles.length > 0) {
                    let news = `ğŸ“° **Latest News: ${topic}**\n\n`;
                    data.articles.slice(0, 5).forEach((article, i) => {
                        news += `${i+1}. **${article.title}**\n   ${article.description?.substring(0, 100)}...\n   ğŸ”— ${article.url}\n\n`;
                    });
                    return news;
                } else {
                    return `ğŸ“° No recent news found for "${topic}". Try a different topic.`;
                }
            } catch (error) {
                return 'âŒ News service error. Check your API key in settings.';
            }
        }

        async function convertCurrency(args) {
            try {
                // Parse: "100 USD to EUR"
                const match = args.match(/(\d+\.?\d*)\s*(\w+)\s+to\s+(\w+)/i);
                if (!match) {
                    return 'ğŸ’± Usage: /currency 100 USD to EUR';
                }
                
                const [, amount, from, to] = match;
                const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${from.toUpperCase()}`);
                const data = await response.json();
                
                if (data.rates && data.rates[to.toUpperCase()]) {
                    const rate = data.rates[to.toUpperCase()];
                    const result = (parseFloat(amount) * rate).toFixed(2);
                    return `ğŸ’± **Currency Conversion:**\n\n${amount} ${from.toUpperCase()} = ${result} ${to.toUpperCase()}\n\nğŸ“Š Rate: 1 ${from.toUpperCase()} = ${rate.toFixed(4)} ${to.toUpperCase()}`;
                } else {
                    return `ğŸ’± Invalid currency code. Try: /currency 100 USD to EUR`;
                }
            } catch (error) {
                return 'âŒ Currency conversion failed. Check currency codes (USD, EUR, GBP, etc.)';
            }
        }

        async function getDefinition(word) {
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
                const data = await response.json();
                
                if (Array.isArray(data) && data[0]) {
                    const entry = data[0];
                    const meaning = entry.meanings[0];
                    const definition = meaning.definitions[0];
                    
                    return `ğŸ“– **${entry.word}** (${meaning.partOfSpeech})\n\n**Definition:** ${definition.definition}\n\n${definition.example ? `**Example:** "${definition.example}"` : ''}`;
                } else {
                    return `ğŸ“– No definition found for "${word}". Check spelling.`;
                }
            } catch (error) {
                return `ğŸ“– Dictionary lookup failed for "${word}".`;
            }
        }

        async function translateText(args) {
            // Simple translation using MyMemory API (free, no key needed)
            const match = args.match(/(.+?)\s+to\s+(\w+)/i);
            if (!match) {
                return 'ğŸŒ Usage: /translate hello to spanish\n\nSupported: spanish, french, german, italian, portuguese, japanese, chinese, etc.';
            }
            
            const [, text, lang] = match;
            const langCodes = {
                'spanish': 'es', 'french': 'fr', 'german': 'de', 'italian': 'it',
                'portuguese': 'pt', 'japanese': 'ja', 'chinese': 'zh', 'korean': 'ko',
                'russian': 'ru', 'arabic': 'ar', 'hindi': 'hi'
            };
            
            const targetLang = langCodes[lang.toLowerCase()] || lang.toLowerCase();
            
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|${targetLang}`);
                const data = await response.json();
                
                if (data.responseData && data.responseData.translatedText) {
                    return `ğŸŒ **Translation:**\n\n**English:** ${text}\n**${lang}:** ${data.responseData.translatedText}`;
                } else {
                    return `ğŸŒ Translation failed. Try: /translate hello to spanish`;
                }
            } catch (error) {
                return 'âŒ Translation service error.';
            }
        }

        async function getTimeIn(location) {
            try {
                const response = await fetch(`https://worldtimeapi.org/api/timezone`);
                const timezones = await response.json();
                
                // Find matching timezone
                const match = timezones.find(tz => tz.toLowerCase().includes(location.toLowerCase()));
                
                if (match) {
                    const timeResponse = await fetch(`https://worldtimeapi.org/api/timezone/${match}`);
                    const timeData = await timeResponse.json();
                    const dateTime = new Date(timeData.datetime);
                    
                    return `ğŸ• **Time in ${match}:**\n\n${dateTime.toLocaleString()}\n\nTimezone: ${timeData.timezone}\nUTC Offset: ${timeData.utc_offset}`;
                } else {
                    return `ğŸ• Location not found. Try: /time London or /time America/New_York`;
                }
            } catch (error) {
                const now = new Date();
                return `ğŸ• Current time: ${now.toLocaleString()}`;
            }
        }

        function getQuickReplies(response) {
            const lower = response.toLowerCase();
            if (lower.includes('search') || lower.includes('ğŸ”')) return ['Search more', 'Thanks'];
            if (lower.includes('weather') || lower.includes('ğŸŒ¤ï¸')) return ['Another city', 'Thanks'];
            if (lower.includes('?')) return ['Yes', 'No', 'Tell me more'];
            return null;
        }

        function showCommands() {
            handleCommand('/help');
        }

        function addMessage(text, sender, quickReplies = null) {
            messages.push({ text, sender, time: Date.now(), quickReplies });
            render();
            saveMessages();
        }

        function showTyping() {
            const container = document.getElementById('messages');
            const typing = document.createElement('div');
            typing.id = 'typing';
            typing.className = 'flex gap-2 slide-in';
            typing.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 flex items-center justify-center text-xl">ğŸ¤–</div>
                <div class="bg-white shadow rounded-2xl px-4 py-3 flex gap-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot" style="animation-delay: 0.2s;"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot" style="animation-delay: 0.4s;"></div>
                </div>
            `;
            container.appendChild(typing);
            container.scrollTop = container.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        function render() {
            const container = document.getElementById('messages');
            if (messages.length === 0) return;
            
            let html = '';
            messages.forEach((msg, idx) => {
                const isUser = msg.sender === 'user';
                const isLast = idx === messages.length - 1;
                
                html += `
                    <div class="flex gap-2 ${isUser ? 'flex-row-reverse' : ''} slide-in">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-xl ${isUser ? 'bg-indigo-600 text-white' : 'bg-gradient-to-r from-indigo-500 to-purple-500'}">
                            ${isUser ? 'ğŸ‘¤' : 'ğŸ¤–'}
                        </div>
                        <div class="max-w-[70%]">
                            <div class="rounded-2xl px-4 py-2 ${isUser ? 'bg-indigo-600 text-white' : 'bg-white shadow'} whitespace-pre-wrap">
                                ${formatMessage(msg.text)}
                            </div>
                            ${msg.quickReplies && isLast ? `
                                <div class="flex gap-2 mt-2 flex-wrap">
                                    ${msg.quickReplies.map(reply => `
                                        <button onclick="quickAction('${reply}')" class="px-3 py-1 bg-gradient-to-r from-indigo-100 to-purple-100 hover:from-indigo-200 hover:to-purple-200 rounded-full text-xs text-indigo-700">
                                            ${reply}
                                        </button>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        function formatMessage(text) {
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-600 underline">$1</a>');
            return text;
        }

        async function getAIResponse(text) {
            const name = config.userName || 'friend';
            
            if (config.mode === 'rules') {
                return getRuleResponse(text, name);
            } else if (config.mode === 'gemini') {
                if (!config.geminiKey) throw new Error('Gemini API key not set');
                return await callGemini(text, name);
            } else if (config.mode === 'openai') {
                if (!config.openaiKey) throw new Error('OpenAI API key not set');
                return await callOpenAI(text, name);
            }
        }

        function getRuleResponse(msg, name) {
            const m = msg.toLowerCase();
            
            if (m.match(/search|find|look up/)) {
                return `I can search the internet! Try:\nâ€¢ /search [query]\nâ€¢ /wiki [topic]\nâ€¢ /news [topic]`;
            }
            
            if (m.match(/weather/)) {
                return `Want weather? Try: /weather [city name]\nExample: /weather Tokyo`;
            }
            
            if (m.match(/^(hi|hello|hey)/)) return `Hey ${name}! ğŸ‘‹ I'm super powered with internet access! Try /help`;
            if (m.match(/how are you/)) return `Fantastic! ğŸš€ I can now search the web, check weather, translate, and more!`;
            if (m.match(/what can you do/)) return `I'm super powered! ğŸ’ª\n\nğŸ” Search web\nğŸŒ¤ï¸ Weather\nğŸ“° News\nğŸ’± Currency\nğŸ“– Dictionary\nğŸŒ Translate\n\nType /help for all commands!`;
            
            return `Try asking me to search something, or type /help to see all my powers! ğŸš€`;
        }

        async function callGemini(text, name) {
            const personality = config.personality || 'friendly';
            const prompt = `You are I-Stein Super Powered, a helpful AI with internet capabilities. ${name !== 'friend' ? `User's name: ${name}.` : ''} Be ${personality}. Brief (2-3 sentences). If they ask about your capabilities, mention you can search web, check weather, news, translate, and more via commands.\n\nUser: ${text}\n\nAssistant:`;
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${config.geminiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });
            
            if (!response.ok) {
                const status = response.status;
                if (status === 403) throw new Error('Invalid Gemini API key');
                if (status === 429) throw new Error('Rate limit. Wait 1 minute');
                throw new Error('Gemini error: ' + status);
            }
            
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        async function callOpenAI(text, name) {
            const personality = config.personality || 'friendly';
            const systemMsg = `You are I-Stein Super Powered, helpful AI with internet capabilities. ${name !== 'friend' ? `User: ${name}.` : ''} Be ${personality}. Brief (2-3 sentences).`;
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.openaiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        { role: 'system', content: systemMsg },
                        { role: 'user', content: text }
                    ]
                })
            });
            
            if (!response.ok) throw new Error('OpenAI error');
            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Settings
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('aiMode').value = config.mode;
            document.getElementById('geminiKey').value = config.geminiKey;
            document.getElementById('openaiKey').value = config.openaiKey;
            document.getElementById('weatherKey').value = config.weatherKey;
            document.getElementById('newsKey').value = config.newsKey;
            document.getElementById('autoSpeak').checked = config.autoSpeak;
            document.getElementById('continuousListen').checked = config.continuousListen;
            document.getElementById('voiceSpeed').value = config.voiceSpeed;
            document.getElementById('voiceNum').value = config.voiceNum;
            document.getElementById('userName').value = config.userName;
            document.getElementById('personality').value = config.personality;
            document.getElementById('speedVal').textContent = config.voiceSpeed;
            toggleAISettings();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function toggleAISettings() {
            const mode = document.getElementById('aiMode').value;
            document.getElementById('geminiSettings').classList.toggle('hidden', mode !== 'gemini');
            document.getElementById('openaiSettings').classList.toggle('hidden', mode !== 'openai');
        }

        function saveSettings() {
            config.mode = document.getElementById('aiMode').value;
            config.geminiKey = document.getElementById('geminiKey').value;
            config.openaiKey = document.getElementById('openaiKey').value;
            config.weatherKey = document.getElementById('weatherKey').value;
            config.newsKey = document.getElementById('newsKey').value;
            config.autoSpeak = document.getElementById('autoSpeak').checked;
            config.continuousListen = document.getElementById('continuousListen').checked;
            config.voiceSpeed = parseFloat(document.getElementById('voiceSpeed').value);
            config.voiceNum = parseInt(document.getElementById('voiceNum').value);
            config.userName = document.getElementById('userName').value;
            config.personality = document.getElementById('personality').value;
            
            saveConfig();
            closeSettings();
            greetUser();
            
            if (config.continuousListen && !isListening) {
                recognition.start();
            } else if (!config.continuousListen && isListening) {
                recognition.stop();
            }
            
            showToast('âœ… All settings saved!');
        }

        function saveConfig() {
            localStorage.setItem('config', JSON.stringify(config));
        }

        function loadConfig() {
            const saved = localStorage.getItem('config');
            if (saved) config = {...config, ...JSON.parse(saved)};
            
            const savedNotes = localStorage.getItem('notes');
            if (savedNotes) notes = JSON.parse(savedNotes);
            
            const savedTodos = localStorage.getItem('todos');
            if (savedTodos) todos = JSON.parse(savedTodos);
            
            if (config.continuousListen) {
                setTimeout(() => {
                    if (recognition) recognition.start();
                }, 1000);
            }
        }

        function saveMessages() {
            localStorage.setItem('messages', JSON.stringify(messages));
        }

        function loadMessages() {
            const saved = localStorage.getItem('messages');
            if (saved) {
                messages = JSON.parse(saved);
                render();
            }
        }

        function clearChat() {
            if (confirm('Clear chat?')) {
                messages = [];
                localStorage.removeItem('messages');
                location.reload();
            }
        }
    </script>
</body>
</html>
