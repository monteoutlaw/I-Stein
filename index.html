                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border-2 border-green-300">
                        <h3 class="font-bold text-lg mb-2">üé§ Voice Setup (Built-in!)</h3>
                        <p class="text-sm text-gray-700 mb-2">Voice is already enabled! Just click the red microphone button.</p>
                        <ul class="text-sm text-gray-700 space-y-1 ml-4 list-disc">
                            <li>Click üé§ button to speak</li>
                            <li>Allow microphone access when prompted</li>
                            <li>Speak your question</li>
                            <li>I-Stein will respond (with voice if enabled)</li>
                        </ul>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="font-bold text-lg mb-2">‚ú® Get FREE AI (Recommended)</h3>
                        <ol class="text-sm text-gray-700 space-y-1 ml-4 list-decimal">
                            <li>Visit <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-600 underline">Google AI Studio</a></li>
                            <li>Create API Key (100% FREE)</li>
                            <li>Click ‚öôÔ∏è Settings ‚Üí Select Gemini ‚Üí Paste key</li>
                            <li>Save and enjoy smart responses!</li>
                        </ol>
                    </div>
                </div>

                <button onclick="closeSetupGuide(); openSettings();" class="w-full mt-6 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 font-medium">
                    ‚öôÔ∏è Open Settings
                </button>
            </div>
        </div>
    </div>

    <script>
        let messages = [];
        let settings = {
            aiMode: 'rules',
            openaiKey: '',
            openaiModel: 'gpt-4o-mini',
            claudeKey: '',
            claudeModel: 'claude-sonnet-4-5-20250929',
            geminiKey: '',
            geminiModel: 'gemini-2.0-flash-exp',
            temperature: 0.7,
            systemPrompt: "You are I-Stein, a helpful and intelligent Scottish assistant. You speak with Scottish expressions and dialect (use words like 'och', 'aye', 'braw', 'dinnae', 'wee', 'bonnie', etc.). You're knowledgeable, friendly, and always eager to help. Keep your responses conversational and engaging while maintaining your Scottish personality.",
            voiceEnabled: true,
            autoVoiceOutput: false,
            voiceRate: 1.0,
            voicePitch: 1.0,
            selectedVoice: null
        };

        let recognition = null;
        let synthesis = window.speechSynthesis;
        let isListening = false;

        // Initialize speech recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('voiceButton').classList.add('listening-indicator', 'pulse-ring');
                    showToast('üé§ Listening... Speak now!');
                };

                recognition.onend = () => {
                    isListening = false;
                    document.getElementById('voiceButton').classList.remove('listening-indicator', 'pulse-ring');
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('messageInput').value = transcript;
                    showToast('üìù Got it: "' + transcript + '"');
                    setTimeout(() => sendMessage(), 500);
                };

                recognition.onerror = (event) => {
                    showToast('‚ùå Voice error: ' + event.error);
                    isListening = false;
                    document.getElementById('voiceButton').classList.remove('listening-indicator', 'pulse-ring');
                };
            }
        }

        // Load available voices
        function loadVoices() {
            const voices = synthesis.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '<option value="">Default</option>';
            
            voices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${voice.name} (${voice.lang})`;
                if (voice.lang.includes('en-GB') || voice.lang.includes('en-IE')) {
                    option.textContent += ' üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø';
                }
                voiceSelect.appendChild(option);
            });
        }

        // Start voice input
        function startVoiceInput() {
            if (!recognition) {
                showToast('‚ùå Voice input not supported in this browser. Try Chrome or Edge.');
                return;
            }

            if (isListening) {
                recognition.stop();
                return;
            }

            try {
                recognition.start();
            } catch (error) {
                showToast('‚ùå Could not start voice input: ' + error.message);
            }
        }

        // Speak text
        function speakText(text) {
            if (!settings.voiceEnabled && !settings.autoVoiceOutput) return;

            // Cancel any ongoing speech
            synthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = parseFloat(settings.voiceRate);
            utterance.pitch = parseFloat(settings.voicePitch);

            if (settings.selectedVoice !== null) {
                const voices = synthesis.getVoices();
                utterance.voice = voices[settings.selectedVoice];
            }

            synthesis.speak(utterance);
        }

        // Toggle voice output
        function toggleVoiceOutput() {
            settings.autoVoiceOutput = !settings.autoVoiceOutput;
            saveSettingsToStorage();
            
            const button = document.getElementById('voiceToggle');
            if (settings.autoVoiceOutput) {
                button.classList.add('bg-green-100');
                showToast('üîä Auto-speak enabled');
            } else {
                button.classList.remove('bg-green-100');
                showToast('üîá Auto-speak disabled');
            }
        }

        // Test voice
        function testVoice() {
            speakText("Och aye! This is I-Stein speakin' tae ye. How dae ye like ma voice?");
        }

        // Update voice displays
        function updateRateDisplay() {
            document.getElementById('rateValue').textContent = document.getElementById('voiceRate').value;
        }

        function updatePitchDisplay() {
            document.getElementById('pitchValue').textContent = document.getElementById('voicePitch').value;
        }

        // Save voice settings
        function saveVoiceSettings() {
            settings.autoVoiceOutput = document.getElementById('autoVoiceOutput').checked;
            settings.voiceRate = document.getElementById('voiceRate').value;
            settings.voicePitch = document.getElementById('voicePitch').value;
            settings.selectedVoice = document.getElementById('voiceSelect').value || null;
            saveSettingsToStorage();
        }

        // Atom icon component
        function createAtomIcon(isVibrating = false) {
            return `
                <svg class="w-5 h-5 text-gray-700 ${isVibrating ? 'animate-vibrate' : ''}" viewBox="0 0 24 24" fill="none">
                    <defs>
                        <radialGradient id="nucleusGradient3">
                            <stop offset="0%" stop-color="#fbbf24" />
                            <stop offset="100%" stop-color="#f59e0b" />
                        </radialGradient>
                        <linearGradient id="orbit1-3" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#3b82f6" />
                            <stop offset="100%" stop-color="#8b5cf6" />
                        </linearGradient>
                        <linearGradient id="orbit2-3" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#ec4899" />
                            <stop offset="100%" stop-color="#f43f5e" />
                        </linearGradient>
                        <linearGradient id="orbit3-3" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#10b981" />
                            <stop offset="100%" stop-color="#06b6d4" />
                        </linearGradient>
                    </defs>
                    <circle cx="12" cy="12" r="2.5" fill="url(#nucleusGradient3)">
                        <animate attributeName="r" values="2.5;3;2.5" dur="2s" repeatCount="indefinite" />
                    </circle>
                    <circle cx="12" cy="12" r="1.5" fill="#fef3c7" opacity="0.8" />
                    <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(0 12 12)" stroke="url(#orbit1-3)" stroke-width="1.5" fill="none" opacity="0.8">
                        <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="3s" repeatCount="indefinite" />
                    </ellipse>
                    <circle cx="22" cy="12" r="1.5" fill="#3b82f6">
                        <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="3s" repeatCount="indefinite" />
                    </circle>
                    <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(60 12 12)" stroke="url(#orbit2-3)" stroke-width="1.5" fill="none" opacity="0.8">
                        <animateTransform attributeName="transform" type="rotate" from="60 12 12" to="420 12 12" dur="2.5s" repeatCount="indefinite" />
                    </ellipse>
                    <circle cx="22" cy="12" r="1.5" fill="#ec4899" transform="rotate(60 12 12)">
                        <animateTransform attributeName="transform" type="rotate" from="60 12 12" to="420 12 12" dur="2.5s" repeatCount="indefinite" />
                    </circle>
                    <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(120 12 12)" stroke="url(#orbit3-3)" stroke-width="1.5" fill="none" opacity="0.8">
                        <animateTransform attributeName="transform" type="rotate" from="120 12 12" to="480 12 12" dur="3.5s" repeatCount="indefinite" />
                    </ellipse>
                    <circle cx="22" cy="12" r="1.5" fill="#10b981" transform="rotate(120 12 12)">
                        <animateTransform attributeName="transform" type="rotate" from="120 12 12" to="480 12 12" dur="3.5s" repeatCount="indefinite" />
                    </circle>
                </svg>
            `;
        }

        // Toast notification
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Load from localStorage
        function loadData() {
            const savedMessages = localStorage.getItem('istein-messages');
            const savedSettings = localStorage.getItem('istein-settings');
            
            if (savedMessages) {
                messages = JSON.parse(savedMessages);
                renderMessages();
            }
            
            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
                updateAIModeDisplay();
                
                // Update voice toggle button state
                if (settings.autoVoiceOutput) {
                    document.getElementById('voiceToggle').classList.add('bg-green-100');
                }
            }
        }

        // Save to localStorage
        function saveMessages() {
            localStorage.setItem('istein-messages', JSON.stringify(messages));
        }

        function saveSettingsToStorage() {
            localStorage.setItem('istein-settings', JSON.stringify(settings));
        }

        // Rule-based response
        function generateRuleBasedResponse(userMessage) {
            const msg = userMessage.toLowerCase();
            
            if (msg.match(/^(hi|hello|hey|greetings)/)) {
                return "Och, hello there! I'm I-Stein, yer intelligent assistant. How can I help ye today?";
            }
            
            if (msg.match(/how are you|how's it going|what's up/)) {
                return "Aye, I'm doing braw, thank ye fer askin'! Ready tae help ye with whatever ye need.";
            }
            
            if (msg.match(/help|what can you do|capabilities/)) {
                return "Weel now, I can answer yer questions, have a guid blether, and assist with all sorts o' tasks. Just ask away and I'll dae ma best tae help!";
            }
            
            if (msg.match(/time|date|today|day/)) {
                const now = new Date();
                return `Aye, it's currently ${now.toLocaleString()}. What can I dae fer ye?`;
            }
            
            if (msg.match(/thank|thanks|thx/)) {
                return "Och, yer most welcome! Dinnae hesitate tae ask if ye need anythin' else.";
            }
            
            if (msg.match(/bye|goodbye|see you|later/)) {
                return "Cheerio! Come back any time ye need a hand, I'll be here!";
            }
            
            if (msg.match(/your name|who are you|what are you/)) {
                return "I'm I-Stein, yer intelligent Scottish assistant! Named after the great minds o' science, I'm here tae help answer yer questions and have a bonnie chat.";
            }

            if (msg.match(/voice|speak|talk/)) {
                return "Aye! I can speak tae ye! Just turn on auto-speak in settings or click the speaker icon. And ye can talk tae me by clickin' the microphone button!";
            }
            
            const defaultResponses = [
                "Och, that's interesting! Tell me more aboot that.",
                "Aye, I understand. How can I help ye with that?",
                "Thanks fer sharin'! What would ye like tae know?",
                "I'm here tae help! Could ye gie me a wee bit more detail?",
                "That's a braw question! Let me think on that...",
                "Interesting stuff! What else can I help ye with?",
            ];
            
            return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
        }

        // OpenAI API Call
        async function callOpenAI(userMessage) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${settings.openaiKey}`
                },
                body: JSON.stringify({
                    model: settings.openaiModel,
                    messages: [
                        { role: 'system', content: settings.systemPrompt },
                        ...messages.slice(-10).map(m => ({
                            role: m.sender === 'user' ? 'user' : 'assistant',
                            content: m.text
                        })),
                        { role: 'user', content: userMessage }
                    ],
                    temperature: parseFloat(settings.temperature)
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || response.statusText);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Claude API Call
        async function callClaude(userMessage) {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': settings.claudeKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: settings.claudeModel,
                    max_tokens: 2048,
                    temperature: parseFloat(settings.temperature),
                    system: settings.systemPrompt,
                    messages: [
                        ...messages.slice(-10).map(m => ({
                            role: m.sender === 'user' ? 'user' : 'assistant',
                            content: m.text
                        })),
                        { role: 'user', content: userMessage }
                    ]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || response.statusText);
            }

            const data = await response.json();
            return data.content[0].text;
        }

        // Gemini API Call
        async function callGemini(userMessage) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${settings.geminiModel}:generateContent?key=${settings.geminiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [
                        {
                            parts: [
                                { text: settings.systemPrompt + '\n\nUser: ' + userMessage + '\n\nAssistant:' }
                            ]
                        }
                    ],
                    generationConfig: {
                        temperature: parseFloat(settings.temperature),
                        maxOutputTokens: 2048
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || response.statusText);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // Generate response based on AI mode
        async function generateResponse(userMessage) {
            try {
                switch (settings.aiMode) {
                    case 'openai':
                        if (!settings.openaiKey) {
                            showToast('‚ö†Ô∏è OpenAI API key not set!');
                            return "Och! Ye need tae set yer OpenAI API key in settings first. Click the gear icon at the top!";
                        }
                        return await callOpenAI(userMessage);
                    
                    case 'claude':
                        if (!settings.claudeKey) {
                            showToast('‚ö†Ô∏è Claude API key not set!');
                            return "Och! Ye need tae set yer Claude API key in settings first. Click the gear icon at the top!";
                        }
                        return await callClaude(userMessage);
                    
                    case 'gemini':
                        if (!settings.geminiKey) {
                            showToast('‚ö†Ô∏è Gemini API key not set!');
                            return "Och! Ye need tae set yer Gemini API key in settings first. Click the gear icon at the top!";
                        }
                        return await callGemini(userMessage);
                    
                    default:
                        return generateRuleBasedResponse(userMessage);
                }
            } catch (error) {
                console.error('AI Error:', error);
                showToast('‚ùå AI Error: ' + error.message);
                return `Och, I'm havin' trouble connectin' tae the AI service. Error: ${error.message}`;
            }
        }

        // Render messages
        function renderMessages() {
            const container = document.getElementById('messages');
            const welcome = document.getElementById('welcomeMessage');
            
            if (messages.length === 0) {
                welcome.style.display = 'block';
                return;
            }
            
            welcome.style.display = 'none';
            
            let html = '';
            messages.forEach(msg => {
                const isUser = msg.sender === 'user';
                html += `
                    <div class="flex gap-2 sm:gap-3 ${isUser ? 'flex-row-reverse' : 'flex-row'} message-animate">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${isUser ? 'bg-indigo-600' : 'bg-gray-300'}">
                            ${isUser ? `
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            ` : createAtomIcon(false)}
                        </div>
                        <div class="max-w-[75%] sm:max-w-[70%] rounded-2xl px-4 py-2 sm:px-4 sm:py-3 ${isUser ? 'bg-indigo-600 text-white' : 'bg-white text-gray-800 shadow-sm'}">
                            <p class="text-sm sm:text-base break-words whitespace-pre-wrap">${msg.text}</p>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = welcome.outerHTML + html;
            scrollToBottom();
        }

        // Show typing indicator
        function showTyping() {
            const container = document.getElementById('messages');
            const typingHtml = `
                <div id="typingIndicator" class="flex gap-2 sm:gap-3">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center">
                        ${createAtomIcon(true)}
                    </div>
                    <div class="bg-white rounded-2xl px-4 py-3 shadow-sm">
                        <div class="flex gap-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', typingHtml);
            scrollToBottom();
        }

        // Hide typing indicator
        function hideTyping() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        // Scroll to bottom
        function scrollToBottom() {
            const container = document.getElementById('messages');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            // Disable input
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            
            // Add user message
            messages.push({
                id: Date.now(),
                text: text,
                sender: 'user',
                timestamp: new Date().toISOString()
            });
            
            input.value = '';
            renderMessages();
            saveMessages();
            
            // Show typing
            showTyping();
            
            // Generate response
            try {
                const response = await generateResponse(text);
                
                hideTyping();
                
                messages.push({
                    id: Date.now() + 1,
                    text: response,
                    sender: 'bot',
                    timestamp: new Date().toISOString()
                });
                
                renderMessages();
                saveMessages();
                
                // Speak response if enabled
                if (settings.autoVoiceOutput) {
                    speakText(response);
                }
            } catch (error) {
                hideTyping();
                console.error('Error generating response:', error);
                showToast('‚ùå Error: ' + error.message);
            } finally {
                // Re-enable input
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                input.focus();
            }
        }

        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Clear chat
        function clearChat() {
            if (confirm('Are ye sure ye want tae clear the chat history?')) {
                messages = [];
                localStorage.removeItem('istein-messages');
                renderMessages();
                showToast('üóëÔ∏è Chat cleared!');
            }
        }

        // Export chat
        function exportChat() {
            if (messages.length === 0) {
                showToast('‚ö†Ô∏è No messages to export!');
                return;
            }
            
            let text = `I-Stein Chat Export - ${new Date().toLocaleString()}\n\n`;
            messages.forEach(msg => {
                text += `${msg.sender === 'user' ? 'You' : 'I-Stein'}: ${msg.text}\n\n`;
            });
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `istein-chat-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('üíæ Chat exported!');
        }

        // Settings Modal Functions
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
            
            // Load current settings into form
            document.getElementById('aiMode').value = settings.aiMode;
            document.getElementById('openaiKey').value = settings.openaiKey;
            document.getElementById('openaiModel').value = settings.openaiModel;
            document.getElementById('claudeKey').value = settings.claudeKey;
            document.getElementById('claudeModel').value = settings.claudeModel;
            document.getElementById('geminiKey').value = settings.geminiKey;
            document.getElementById('geminiModel').value = settings.geminiModel;
            document.getElementById('systemPrompt').value = settings.systemPrompt;
            document.getElementById('autoVoiceOutput').checked = settings.autoVoiceOutput;
            document.getElementById('voiceRate').value = settings.voiceRate;
            document.getElementById('voicePitch').value = settings.voicePitch;
            document.getElementById('voiceSelect').value = settings.selectedVoice || '';
            updateRateDisplay();
            updatePitchDisplay();
            
            updateAIMode();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function updateAIMode() {
            const mode = document.getElementById('aiMode').value;
            
            document.getElementById('openaiSettings').classList.toggle('hidden', mode !== 'openai');
            document.getElementById('claudeSettings').classList.toggle('hidden', mode !== 'claude');
            document.getElementById('geminiSettings').classList.toggle('hidden', mode !== 'gemini');
        }

        function saveSettings() {
            settings.aiMode = document.getElementById('aiMode').value;
            settings.openaiKey = document.getElementById('openaiKey').value;
            settings.openaiModel = document.getElementById('openaiModel').value;
            settings.claudeKey = document.getElementById('claudeKey').value;
            settings.claudeModel = document.getElementById('claudeModel').value;
            settings.geminiKey = document.getElementById('geminiKey').value;
            settings.geminiModel = document.getElementById('geminiModel').value;
            settings.systemPrompt = document.getElementById('systemPrompt').value;
            
            saveVoiceSettings();
            saveSettingsToStorage();
            updateAIModeDisplay();
            closeSettings();
            
            showToast('‚úÖ Settings saved successfully!');
        }

        function resetPrompt() {
            document.getElementById('systemPrompt').value = "You are I-Stein, a helpful and intelligent Scottish assistant. You speak with Scottish expressions and dialect (use words like 'och', 'aye', 'braw', 'dinnae', 'wee', 'bonnie', etc.). You're knowledgeable, friendly, and always eager to help. Keep your responses conversational and engaging while maintaining your Scottish personality.";
            showToast('üîÑ Prompt reset to default');
        }

        function updateAIModeDisplay() {
            const modeDisplay = document.getElementById('aiModeDisplay');
            const modes = {
                'rules': 'üîß Rule-based mode',
                'openai': 'ü§ñ OpenAI ChatGPT',
                'claude': 'üß† Anthropic Claude',
                'gemini': '‚ú® Google Gemini'
            };
            modeDisplay.textContent = modes[settings.aiMode] || 'Rule-based mode';
        }

        // Test connection
        async function testConnection() {
            const mode = document.getElementById('aiMode').value;
            
            if (mode === 'rules') {
                showToast('‚úÖ Rule-based mode works offline!');
                return;
            }
            
            showToast('üß™ Testing connection...');
            
            try {
                const tempSettings = { ...settings };
                settings.aiMode = document.getElementById('aiMode').value;
                settings.openaiKey = document.getElementById('openai<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="I-Stein - Your intelligent Scottish assistant with voice">
    <meta name="theme-color" content="#4f46e5">
    <title>I-Stein - Voice Enabled</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes vibrate {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            10% { transform: translate(-1px, -1px) rotate(-1deg); }
            20% { transform: translate(1px, 1px) rotate(1deg); }
            30% { transform: translate(-1px, 1px) rotate(-1deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, -1px) rotate(-1deg); }
            60% { transform: translate(1px, 1px) rotate(1deg); }
            70% { transform: translate(-1px, 1px) rotate(-1deg); }
            80% { transform: translate(1px, -1px) rotate(1deg); }
            90% { transform: translate(-1px, -1px) rotate(-1deg); }
        }
        .animate-vibrate {
            animation: vibrate 0.3s ease-in-out infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .pulse-ring {
            animation: pulse-ring 1.5s ease-out infinite;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-animate {
            animation: slideIn 0.3s ease-out;
        }
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .toast {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }
        .toast.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        .listening-indicator {
            position: relative;
        }
        .listening-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.3);
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <div id="app" class="flex flex-col h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <!-- Header -->
        <div class="bg-white shadow-md px-4 py-3 sm:px-6 sm:py-4 flex items-center justify-between">
            <div class="flex items-center gap-2 sm:gap-3">
                <div class="bg-indigo-600 p-2 rounded-full">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" viewBox="0 0 24 24" fill="none">
                        <defs>
                            <radialGradient id="nucleusGradient">
                                <stop offset="0%" stop-color="#fbbf24" />
                                <stop offset="100%" stop-color="#f59e0b" />
                            </radialGradient>
                            <linearGradient id="orbit1" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#3b82f6" />
                                <stop offset="100%" stop-color="#8b5cf6" />
                            </linearGradient>
                            <linearGradient id="orbit2" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#ec4899" />
                                <stop offset="100%" stop-color="#f43f5e" />
                            </linearGradient>
                            <linearGradient id="orbit3" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#10b981" />
                                <stop offset="100%" stop-color="#06b6d4" />
                            </linearGradient>
                        </defs>
                        <circle cx="12" cy="12" r="2.5" fill="url(#nucleusGradient)">
                            <animate attributeName="r" values="2.5;3;2.5" dur="2s" repeatCount="indefinite" />
                        </circle>
                        <circle cx="12" cy="12" r="1.5" fill="#fef3c7" opacity="0.8" />
                        <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(0 12 12)" stroke="url(#orbit1)" stroke-width="1.5" fill="none" opacity="0.8">
                            <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="3s" repeatCount="indefinite" />
                        </ellipse>
                        <circle cx="22" cy="12" r="1.5" fill="#3b82f6">
                            <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="3s" repeatCount="indefinite" />
                        </circle>
                        <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(60 12 12)" stroke="url(#orbit2)" stroke-width="1.5" fill="none" opacity="0.8">
                            <animateTransform attributeName="transform" type="rotate" from="60 12 12" to="420 12 12" dur="2.5s" repeatCount="indefinite" />
                        </ellipse>
                        <circle cx="22" cy="12" r="1.5" fill="#ec4899" transform="rotate(60 12 12)">
                            <animateTransform attributeName="transform" type="rotate" from="60 12 12" to="420 12 12" dur="2.5s" repeatCount="indefinite" />
                        </circle>
                        <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(120 12 12)" stroke="url(#orbit3)" stroke-width="1.5" fill="none" opacity="0.8">
                            <animateTransform attributeName="transform" type="rotate" from="120 12 12" to="480 12 12" dur="3.5s" repeatCount="indefinite" />
                        </ellipse>
                        <circle cx="22" cy="12" r="1.5" fill="#10b981" transform="rotate(120 12 12)">
                            <animateTransform attributeName="transform" type="rotate" from="120 12 12" to="480 12 12" dur="3.5s" repeatCount="indefinite" />
                        </circle>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg sm:text-xl font-bold text-gray-800">I-Stein</h1>
                    <p class="text-xs sm:text-sm text-gray-500" id="aiModeDisplay">Rule-based mode</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleVoiceOutput()" id="voiceToggle" class="p-2 hover:bg-gray-100 rounded-full transition-colors" title="Toggle Voice Output">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 1.414m0-7.072a5 5 0 00-1.414 1.414M12 12v.01" />
                    </svg>
                </button>
                <button onclick="exportChat()" class="p-2 hover:bg-gray-100 rounded-full transition-colors" title="Export Chat">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </button>
                <button onclick="openSettings()" class="p-2 hover:bg-gray-100 rounded-full transition-colors" title="Settings">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
                <button onclick="clearChat()" class="p-2 hover:bg-gray-100 rounded-full transition-colors" title="Clear chat">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Messages -->
        <div id="messages" class="flex-1 overflow-y-auto px-4 py-4 sm:px-6 sm:py-6 space-y-4">
            <div id="welcomeMessage" class="text-center text-gray-500 mt-20">
                <svg class="w-16 h-16 mx-auto mb-4 text-indigo-400" viewBox="0 0 24 24" fill="none">
                    <defs>
                        <radialGradient id="nucleusGradient2">
                            <stop offset="0%" stop-color="#fbbf24" />
                            <stop offset="100%" stop-color="#f59e0b" />
                        </radialGradient>
                        <linearGradient id="orbit1-2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#3b82f6" />
                            <stop offset="100%" stop-color="#8b5cf6" />
                        </linearGradient>
                        <linearGradient id="orbit2-2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#ec4899" />
                            <stop offset="100%" stop-color="#f43f5e" />
                        </linearGradient>
                        <linearGradient id="orbit3-2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#10b981" />
                            <stop offset="100%" stop-color="#06b6d4" />
                        </linearGradient>
                    </defs>
                    <circle cx="12" cy="12" r="2.5" fill="url(#nucleusGradient2)">
                        <animate attributeName="r" values="2.5;3;2.5" dur="2s" repeatCount="indefinite" />
                    </circle>
                    <circle cx="12" cy="12" r="1.5" fill="#fef3c7" opacity="0.8" />
                    <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(0 12 12)" stroke="url(#orbit1-2)" stroke-width="1.5" fill="none" opacity="0.8">
                        <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="3s" repeatCount="indefinite" />
                    </ellipse>
                    <circle cx="22" cy="12" r="1.5" fill="#3b82f6">
                        <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="3s" repeatCount="indefinite" />
                    </circle>
                    <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(60 12 12)" stroke="url(#orbit2-2)" stroke-width="1.5" fill="none" opacity="0.8">
                        <animateTransform attributeName="transform" type="rotate" from="60 12 12" to="420 12 12" dur="2.5s" repeatCount="indefinite" />
                    </ellipse>
                    <circle cx="22" cy="12" r="1.5" fill="#ec4899" transform="rotate(60 12 12)">
                        <animateTransform attributeName="transform" type="rotate" from="60 12 12" to="420 12 12" dur="2.5s" repeatCount="indefinite" />
                    </circle>
                    <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(120 12 12)" stroke="url(#orbit3-2)" stroke-width="1.5" fill="none" opacity="0.8">
                        <animateTransform attributeName="transform" type="rotate" from="120 12 12" to="480 12 12" dur="3.5s" repeatCount="indefinite" />
                    </ellipse>
                    <circle cx="22" cy="12" r="1.5" fill="#10b981" transform="rotate(120 12 12)">
                        <animateTransform attributeName="transform" type="rotate" from="120 12 12" to="480 12 12" dur="3.5s" repeatCount="indefinite" />
                    </circle>
                </svg>
                <p class="text-lg font-medium">Och aye! How can I help ye today?</p>
                <p class="text-sm mt-2">Type or speak your message!</p>
                <div class="mt-4 flex gap-2 justify-center">
                    <button onclick="showSetupGuide()" class="px-6 py-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors text-sm font-medium">
                        üöÄ Setup Guide
                    </button>
                    <button onclick="startVoiceInput()" class="px-6 py-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors text-sm font-medium">
                        üé§ Try Voice
                    </button>
                </div>
            </div>
        </div>

        <!-- Input -->
        <div class="bg-white border-t border-gray-200 px-4 py-3 sm:px-6 sm:py-4">
            <div class="flex gap-2 sm:gap-3 max-w-4xl mx-auto">
                <button 
                    onclick="startVoiceInput()"
                    id="voiceButton"
                    class="bg-red-500 text-white p-2 sm:p-3 rounded-full hover:bg-red-600 transition-colors flex-shrink-0"
                    title="Voice Input"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </button>
                <input 
                    type="text" 
                    id="messageInput"
                    placeholder="Type or click üé§ to speak..."
                    class="flex-1 px-4 py-2 sm:py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm sm:text-base"
                    onkeypress="handleKeyPress(event)"
                />
                <button 
                    onclick="sendMessage()"
                    class="bg-indigo-600 text-white p-2 sm:p-3 rounded-full hover:bg-indigo-700 transition-colors flex-shrink-0"
                    id="sendButton"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <p id="toastMessage"></p>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">‚öôÔ∏è I-Stein Settings</h2>
                    <button onclick="closeSettings()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Voice Settings -->
                <div class="mb-6 p-4 bg-red-50 rounded-lg border-2 border-red-200">
                    <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <span>üé§</span> Voice Settings
                    </h3>
                    
                    <div class="mb-3">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="autoVoiceOutput" onchange="saveVoiceSettings()" class="w-4 h-4"/>
                            <span class="text-sm">Auto-speak responses</span>
                        </label>
                    </div>

                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Voice</label>
                        <select id="voiceSelect" onchange="saveVoiceSettings()" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Default</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Speed: <span id="rateValue">1.0</span>x
                        </label>
                        <input type="range" id="voiceRate" min="0.5" max="2" step="0.1" value="1" class="w-full" oninput="updateRateDisplay(); saveVoiceSettings()" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Pitch: <span id="pitchValue">1.0</span>
                        </label>
                        <input type="range" id="voicePitch" min="0.5" max="2" step="0.1" value="1" class="w-full" oninput="updatePitchDisplay(); saveVoiceSettings()" />
                    </div>

                    <button onclick="testVoice()" class="mt-3 w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm font-medium">
                        üîä Test Voice
                    </button>
                </div>

                <!-- AI Mode Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">AI Mode</label>
                    <select id="aiMode" onchange="updateAIMode()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="rules">üîß Rule-Based (Free, Offline)</option>
                        <option value="openai">ü§ñ OpenAI ChatGPT</option>
                        <option value="claude">üß† Anthropic Claude</option>
                        <option value="gemini">‚ú® Google Gemini (Free!)</option>
                    </select>
                </div>

                <!-- OpenAI Settings -->
                <div id="openaiSettings" class="hidden mb-6 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                    <h3 class="font-semibold text-gray-800 mb-2">ü§ñ OpenAI API</h3>
                    <input type="password" id="openaiKey" placeholder="sk-proj-..." class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2" />
                    <select id="openaiModel" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2">
                        <option value="gpt-4o-mini">GPT-4o Mini (Recommended)</option>
                        <option value="gpt-4o">GPT-4o</option>
                    </select>
                    <p class="text-xs text-gray-600">Get key: <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 underline">platform.openai.com</a></p>
                </div>

                <!-- Claude Settings -->
                <div id="claudeSettings" class="hidden mb-6 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                    <h3 class="font-semibold text-gray-800 mb-2">üß† Claude API</h3>
                    <input type="password" id="claudeKey" placeholder="sk-ant-..." class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2" />
                    <select id="claudeModel" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2">
                        <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5</option>
                        <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                    </select>
                    <p class="text-xs text-gray-600">Get key: <a href="https://console.anthropic.com" target="_blank" class="text-blue-600 underline">console.anthropic.com</a></p>
                </div>

                <!-- Gemini Settings -->
                <div id="geminiSettings" class="hidden mb-6 p-4 bg-green-50 rounded-lg border-2 border-green-200">
                    <h3 class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                        ‚ú® Google Gemini <span class="text-xs bg-green-600 text-white px-2 py-1 rounded">FREE!</span>
                    </h3>
                    <input type="password" id="geminiKey" placeholder="AIzaSy..." class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2" />
                    <select id="geminiModel" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2">
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (FREE)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                    </select>
                    <p class="text-xs text-green-600 font-medium">Get FREE key: <a href="https://makersuite.google.com/app/apikey" target="_blank" class="underline">Google AI Studio</a></p>
                </div>

                <!-- System Prompt -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">System Prompt</label>
                    <textarea id="systemPrompt" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
                    <button onclick="resetPrompt()" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">Reset</button>
                </div>

                <div class="flex gap-3">
                    <button onclick="saveSettings()" class="flex-1 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 font-medium">
                        üíæ Save
                    </button>
                    <button onclick="testConnection()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                        üß™ Test
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Guide Modal -->
    <div id="setupGuideModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">üöÄ Quick Setup</h2>
                    <button onclick="closeSetupGuide()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border-2 border-green-300">
                        <h3 class="font-bold text-lg mb-