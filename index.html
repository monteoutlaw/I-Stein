<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Iâ€‘Stein âš¡ Super Powered (Single Cleaned HTML)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes typing { 0%,100%{opacity:.3} 50%{opacity:1} }
    .typing-dot{animation:typing 1.4s infinite}
    .listening-pulse{animation:pulse 1.5s cubic-bezier(.4,0,.6,1) infinite}
    @keyframes pulse {0%,100%{opacity:1} 50%{opacity:.5}}
    .slide-in{animation:slideIn .3s ease-out}
    @keyframes slideIn{from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)}}
    .result-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <!-- Settings Modal -->
  <div id="settingsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 overflow-y-auto">
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold">âš™ï¸ Super Powered Settings</h2>
          <button onclick="closeSettings()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>

        <!-- AI Mode -->
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">AI Mode</label>
          <select id="aiMode" onchange="toggleAISettings()" class="w-full px-4 py-2 border rounded-lg">
            <option value="rules">ğŸ”§ Rule-Based (Free, Offline)</option>
            <option value="gemini">âœ¨ Google Gemini (Free key)</option>
            <option value="openai">ğŸ¤– OpenAI ChatGPT (key required)</option>
          </select>
        </div>

        <div id="geminiSettings" class="hidden mb-4 p-4 bg-green-50 rounded-lg border-2 border-green-200">
          <h3 class="font-semibold mb-2">âœ¨ Google Gemini</h3>
          <input type="password" id="geminiKey" placeholder="AIzaSy..." class="w-full px-4 py-2 border rounded-lg mb-2"/>
          <p class="text-xs text-gray-600">Get a free key at <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-600 underline">Google AI Studio</a></p>
        </div>

        <div id="openaiSettings" class="hidden mb-4 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
          <h3 class="font-semibold mb-2">ğŸ¤– OpenAI</h3>
          <input type="password" id="openaiKey" placeholder="sk-..." class="w-full px-4 py-2 border rounded-lg mb-2"/>
          <p class="text-xs text-gray-600">For production, route through your own backend/proxy â€” avoid exposing keys client-side.</p>
        </div>

        <!-- Internet (Optional) -->
        <div class="mb-4 p-4 bg-yellow-50 rounded-lg border-2 border-yellow-200">
          <h3 class="font-semibold mb-3">ğŸŒ Internet Features (Optional)</h3>
          <label class="block text-sm font-medium mb-1">Weather API Key (OpenWeather):</label>
          <input type="password" id="weatherKey" placeholder="Optional - openweathermap.org" class="w-full px-4 py-2 border rounded-lg mb-3 text-sm"/>
          <label class="block text-sm font-medium mb-1">News API Key (NewsAPI):</label>
          <input type="password" id="newsKey" placeholder="Optional - newsapi.org" class="w-full px-4 py-2 border rounded-lg mb-3 text-sm"/>
          <div class="text-xs text-gray-600 bg-white p-3 rounded">
            <strong>Note:</strong> Search & Wikipedia work without keys. Weather/News need free keys.
          </div>
        </div>

        <!-- Voice -->
        <div class="mb-4 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
          <h3 class="font-semibold mb-3">ğŸ¤ Voice</h3>
          <label class="flex items-center gap-2 mb-3">
            <input type="checkbox" id="continuousListen" class="w-4 h-4"/>
            <span class="text-sm font-medium">ğŸ™ï¸ Always Listen</span>
          </label>
          <label class="flex items-center gap-2 mb-3">
            <input type="checkbox" id="autoSpeak" class="w-4 h-4"/>
            <span class="text-sm font-medium">Auto-speak responses</span>
          </label>
          <label class="block text-sm mb-1">Voice #:
            <input type="number" id="voiceNum" min="0" max="21" value="5" class="w-20 px-2 py-1 border rounded"/>
          </label>
          <label class="block text-sm mb-1">Speed: <span id="speedVal">1.3</span>x</label>
          <input type="range" id="voiceSpeed" min="0.5" max="2" step="0.1" value="1.3" class="w-full mb-2" oninput="document.getElementById('speedVal').textContent=this.value"/>
        </div>

        <!-- Personality -->
        <div class="mb-4 p-4 bg-pink-50 rounded-lg border-2 border-pink-200">
          <h3 class="font-semibold mb-3">ğŸ˜Š Personality</h3>
          <label class="block text-sm mb-1">Your Name:</label>
          <input type="text" id="userName" placeholder="Optional" class="w-full px-4 py-2 border rounded-lg mb-3"/>
          <label class="block text-sm mb-1">Style:</label>
          <select id="personality" class="w-full px-4 py-2 border rounded-lg">
            <option value="friendly">ğŸ˜Š Friendly</option>
            <option value="professional">ğŸ’¼ Professional</option>
            <option value="funny">ğŸ˜‚ Funny</option>
            <option value="motivational">ğŸ’ª Motivational</option>
          </select>
        </div>

        <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 font-medium">ğŸ’¾ Save All Settings</button>
      </div>
    </div>
  </div>

  <!-- App Shell -->
  <div class="flex flex-col h-screen">
    <!-- Header -->
    <div class="bg-white shadow-md px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-2 rounded-full relative">
          <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="2" fill="white"/>
            <circle cx="12" cy="12" r="8" stroke="white" stroke-width="2" fill="none"/>
            <path d="M12 2v4m0 12v4m10-10h-4m-12 0H2" stroke="white" stroke-width="2"/>
          </svg>
          <span id="listeningIndicator" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full listening-pulse"></span>
        </div>
        <div>
          <h1 class="text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Iâ€‘Stein âš¡ Super Powered</h1>
          <p class="text-xs text-gray-500" id="statusText">Ready with internet access!</p>
        </div>
      </div>
      <div class="flex gap-2">
        <button onclick="showCommands()" class="p-2 hover:bg-gray-100 rounded-full" title="Commands">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </button>
        <button onclick="openSettings()" class="p-2 hover:bg-gray-100 rounded-full" title="Settings">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        </button>
        <button onclick="clearChat()" class="p-2 hover:bg-gray-100 rounded-full" title="Clear">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        </button>
      </div>
    </div>

    <!-- Messages -->
    <div id="messages" class="flex-1 overflow-y-auto px-4 py-4 space-y-3">
      <div class="text-center text-gray-500 mt-20">
        <div class="text-6xl mb-4">ğŸš€âš¡</div>
        <p class="text-lg font-medium" id="welcomeMsg">I'm Iâ€‘Stein Super Powered!</p>
        <p class="text-sm mt-2">Now with internet search, weather, news & more!</p>
        <div class="mt-4 flex gap-2 justify-center flex-wrap">
          <button onclick="quickAction('/search latest AI news')" class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow rounded-full text-sm hover:shadow-lg">ğŸ” Search</button>
          <button onclick="quickAction('/weather New York')" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow rounded-full text-sm hover:shadow-lg">ğŸŒ¤ï¸ Weather</button>
          <button onclick="quickAction('/help')" class="px-4 py-2 bg-white shadow rounded-full text-sm hover:bg-gray-50">ğŸ“š Commands</button>
        </div>
      </div>
    </div>

    <!-- Input -->
    <div class="bg-white border-t px-4 py-3">
      <div class="flex gap-2 max-w-4xl mx-auto">
        <button onclick="toggleContinuousListen()" id="voiceBtn" class="bg-red-500 text-white p-3 rounded-full hover:bg-red-600" title="Toggle Always Listen">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
        </button>
        <input type="text" id="input" placeholder="Ask anything or use /commands..." class="flex-1 px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500" onkeypress="if(event.key==='Enter')send()"/>
        <button onclick="send()" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-3 rounded-full hover:shadow-lg">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    // -------------------- Config & State --------------------
    let messages = [];
    let recognition = null;
    let synthesis = window.speechSynthesis;
    let isListening = false;
    let notes = [];
    let todos = [];

    const REQUEST_TIMEOUT_MS = 25000; // kill hung calls
    let inFlight = null;              // lock to prevent overlapping
    let lastSTT = "";                // de-dupe STT
    let wasListeningBeforeSpeak = false;

    let config = {
      mode: 'rules',
      geminiKey: '',
      openaiKey: '',
      weatherKey: '',
      newsKey: '',
      autoSpeak: false,
      continuousListen: false,
      voiceSpeed: 1.3,
      voiceNum: 5,
      userName: '',
      personality: 'friendly'
    };

    // -------------------- Boot --------------------
    window.onload = () => {
      loadConfig();
      loadMessages();
      initVoice();
      greetUser();
      updateStatus();
    };

    function greetUser(){
      if(config.userName){
        document.getElementById('welcomeMsg').textContent = `Hello ${config.userName}! I'm Super Powered! ğŸš€`;
        document.getElementById('statusText').textContent = `Hey ${config.userName}! Internet ready!`;
      }
    }

    function updateStatus(){
      const modeStr = config.mode ? config.mode.toUpperCase() : 'RULES';
      const keyBadge = (config.mode==='gemini' && config.geminiKey) ? ' ğŸ”‘' : (config.mode==='openai' && config.openaiKey) ? ' ğŸ”‘' : '';
      document.getElementById('statusText').textContent = `Mode: ${modeStr}${keyBadge} â€¢ Internet ready!`;
    }

    // -------------------- Voice (ASR/TTS) --------------------
    function initVoice(){
      if('webkitSpeechRecognition' in window){
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = false;

        recognition.onstart = () => {
          isListening = true;
          document.getElementById('listeningIndicator').classList.remove('hidden');
          document.getElementById('voiceBtn').classList.add('bg-green-500');
          document.getElementById('voiceBtn').classList.remove('bg-red-500');
        };
        recognition.onend = () => {
          isListening = false;
          document.getElementById('listeningIndicator').classList.add('hidden');
          document.getElementById('voiceBtn').classList.remove('bg-green-500');
          document.getElementById('voiceBtn').classList.add('bg-red-500');
          if(config.continuousListen){ setTimeout(()=>{ try{recognition.start()}catch(e){} }, 500); }
        };
        recognition.onspeechend = () => {
          if(config.continuousListen){ setTimeout(()=>{ try{recognition.start()}catch(e){} }, 350); }
        };
        recognition.onresult = (event) => {
          const txt = event.results[event.results.length-1][0].transcript.trim();
          if(!txt || txt===lastSTT) return;
          lastSTT = txt;
          document.getElementById('input').value = txt;
          setTimeout(()=>send(), 200);
        };
        recognition.onerror = (error) => {
          isListening = false;
          document.getElementById('listeningIndicator').classList.add('hidden');
          if(config.continuousListen && (error.error==='no-speech' || error.error==='network')){
            setTimeout(()=>{ try{recognition.start()}catch(e){} }, 800);
          }
        };
      } else {
        document.getElementById('voiceBtn').style.display = 'none';
      }
    }

    function toggleContinuousListen(){
      config.continuousListen = !config.continuousListen;
      saveConfig();
      if(config.continuousListen){ recognition && recognition.start(); showToast('ğŸ™ï¸ Always listening ON!'); }
      else { recognition && recognition.stop(); showToast('ğŸ™ï¸ Manual mode.'); }
    }

    function speak(text){
      if(!config.autoSpeak || !text) return;
      if(recognition && isListening){ wasListeningBeforeSpeak = true; recognition.stop(); } else { wasListeningBeforeSpeak = false; }
      synthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = config.voiceSpeed;
      const voices = synthesis.getVoices();
      if(voices[config.voiceNum]) utter.voice = voices[config.voiceNum];
      utter.onend = ()=>{
        if(recognition && config.continuousListen && wasListeningBeforeSpeak){ setTimeout(()=>recognition.start(), 300); }
      };
      synthesis.speak(utter);
    }

    // -------------------- Networking Helpers --------------------
    async function withTimeout(doFetch, ms){
      const controller = new AbortController();
      const to = setTimeout(()=>controller.abort(new Error('Timeout')), ms);
      try {
        const res = await doFetch(controller.signal);
        clearTimeout(to);
        return res;
      } catch(e){
        clearTimeout(to);
        throw (e.name==='AbortError') ? new Error('Request timed out') : e;
      }
    }

    // -------------------- AI Calls --------------------
    async function getAIResponse(userText){
      if(inFlight){ return 'â³ Still answering the previous requestâ€¦'; }
      inFlight = true;
      try{
        switch(config.mode){
          case 'rules': return ruleBot(userText);
          case 'gemini':
            if(!config.geminiKey) throw new Error('Gemini key missing. Open Settings â†’ enter key.');
            return await callGemini(userText);
          case 'openai':
            if(!config.openaiKey) throw new Error('OpenAI key missing. Open Settings â†’ enter key.');
            return await callOpenAI(userText);
          default: return 'Unknown AI mode';
        }
      } finally { inFlight = false; }
    }

    function ruleBot(t){
      const lc = t.toLowerCase();
      if(lc.includes('hello')||lc.includes('hi')) return "Hey! Iâ€™m Super Powered. What can I do?";
      if(lc.startsWith('/')) return "Try /help for commands.";
      return "Got it. Switch to âœ¨ Gemini or ğŸ¤– OpenAI in Settings for smarter replies.";
    }

    async function callGemini(prompt){
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${encodeURIComponent(config.geminiKey)}`;
      const body = { contents:[{ role:'user', parts:[{ text: prompt }]}], generationConfig:{ temperature:0.8, maxOutputTokens:512 } };
      const doFetch = (signal)=> fetch(url,{ method:'POST', signal, headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) })
        .then(r=>{ if(!r.ok) throw new Error(`Gemini HTTP ${r.status}`); return r.json(); });
      const data = await withTimeout(doFetch, REQUEST_TIMEOUT_MS);
      const cand = data?.candidates?.[0]?.content?.parts?.[0]?.text;
      if(!cand) throw new Error('Empty response from Gemini');
      return cand.trim();
    }

    async function callOpenAI(prompt){
      // NOTE: For production, proxy this on your server to protect keys.
      const url = 'https://api.openai.com/v1/responses';
      const doFetch = (signal)=> fetch(url, {
        method:'POST', signal,
        headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${config.openaiKey}` },
        body: JSON.stringify({ model:'gpt-4o-mini', input: prompt, max_output_tokens:512 })
      }).then(r=>{ if(!r.ok) throw new Error(`OpenAI HTTP ${r.status}`); return r.json(); });
      const data = await withTimeout(doFetch, REQUEST_TIMEOUT_MS);
      const txt = data?.output_text || data?.output?.[0]?.content?.[0]?.text;
      if(!txt) throw new Error('Empty response from OpenAI');
      return txt.trim();
    }

    // -------------------- Send / Commands --------------------
    async function send(){
      const input = document.getElementById('input');
      const text = input.value.trim();
      if(!text) return;

      if(text.startsWith('/')){ await handleCommand(text); input.value=''; return; }
      if(inFlight){ addMessage('â³ Working on your previous requestâ€¦', 'bot'); return; }

      addMessage(text,'user');
      input.value='';
      showTyping();
      try{
        const response = await getAIResponse(text);
        hideTyping();
        addMessage(response,'bot', getQuickReplies(response));
        speak(response);
      } catch(error){
        hideTyping();
        addMessage(`âš ï¸ ${error.message || 'Request failed. Try again.'}`,'bot');
      }
    }

    async function handleCommand(cmd){
      const parts = cmd.split(' ');
      const command = parts[0].toLowerCase();
      const args = parts.slice(1).join(' ');
      showTyping();
      try{
        switch(command){
          case '/help': hideTyping(); addMessage(
            `ğŸš€ **Iâ€‘Stein Commands**\n\n`+
            `**Internet & Search**\n`+
            `â€¢ /search [query]\nâ€¢ /wiki [topic]\nâ€¢ /news [topic]\nâ€¢ /weather [city]\nâ€¢ /currency [amt] [from] to [to]\nâ€¢ /define [word]\nâ€¢ /translate [text] to [lang]\n\n`+
            `**Tools**\n`+
            `â€¢ /calc [expr]\nâ€¢ /time [city]\nâ€¢ /note [text]\nâ€¢ /notes\nâ€¢ /todo [task]\nâ€¢ /todos\nâ€¢ /clear\n`, 'bot');
            break;
          case '/search':
            if(!args){ hideTyping(); addMessage('Usage: /search your query here','bot'); break; }
            const sr = await webSearch(args); hideTyping(); addMessage(sr,'bot');
            break;
          case '/wiki':
            if(!args){ hideTyping(); addMessage('Usage: /wiki topic','bot'); break; }
            const wk = await searchWikipedia(args); hideTyping(); addMessage(wk,'bot');
            break;
          case '/weather':
            if(!args){ hideTyping(); addMessage('Usage: /weather city name','bot'); break; }
            const w = await getWeather(args); hideTyping(); addMessage(w,'bot');
            break;
          case '/news':
            const topic = args || 'latest';
            const n = await getNews(topic); hideTyping(); addMessage(n,'bot');
            break;
          case '/currency':
            const cur = await convertCurrency(args); hideTyping(); addMessage(cur,'bot');
            break;
          case '/define':
            if(!args){ hideTyping(); addMessage('Usage: /define word','bot'); break; }
            const def = await getDefinition(args); hideTyping(); addMessage(def,'bot');
            break;
          case '/translate':
            const tr = await translateText(args); hideTyping(); addMessage(tr,'bot');
            break;
          case '/time':
            const ti = await getTimeIn(args||'UTC'); hideTyping(); addMessage(ti,'bot');
            break;
          case '/joke': hideTyping(); addMessage('Why did the model cross the net? To reduce latency ğŸ”âš¡','bot'); break;
          case '/note':
            hideTyping(); if(args){ notes.push({text:args,time:new Date().toLocaleString()}); localStorage.setItem('notes',JSON.stringify(notes)); addMessage(`ğŸ“ Note saved! Total: ${notes.length}`,'bot'); } else { addMessage('Usage: /note your text','bot'); } break;
          case '/notes':
            hideTyping(); if(!notes.length) addMessage('ğŸ“ No notes yet!','bot');
            else { addMessage('ğŸ“ **Your Notes:**\n\n'+ notes.map((n,i)=>`${i+1}. ${n.text}`).join('\n'),'bot'); }
            break;
          case '/todo':
            hideTyping(); if(args){ todos.push({task:args,done:false}); localStorage.setItem('todos',JSON.stringify(todos)); addMessage(`âœ… Added! Total: ${todos.length}`,'bot'); } else { addMessage('Usage: /todo your task','bot'); } break;
          case '/todos':
            hideTyping(); if(!todos.length) addMessage('âœ… No to-dos yet!','bot');
            else { addMessage('âœ… **To-Dos:**\n\n'+ todos.map((t,i)=>`${i+1}. ${t.done?'âœ“':'â—‹'} ${t.task}`).join('\n'),'bot'); }
            break;
          case '/clear': hideTyping(); clearChat(); break;
          default: hideTyping(); addMessage(`â“ Unknown: ${command} â€” type /help`,'bot');
        }
      } catch(e){ hideTyping(); addMessage(`Error: ${e.message}`,'bot'); }
    }

    // -------------------- Internet Utils (lightweight) --------------------
    async function webSearch(query){
      try{
        const r = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`);
        const d = await r.json();
        if(d.AbstractText) return `ğŸ” **${d.Heading}**\n\n${d.AbstractText}\n\nğŸ“– ${d.AbstractURL||'DuckDuckGo'}`;
        if(d.RelatedTopics?.length){
          return 'ğŸ” **Top Results:**\n\n'+ d.RelatedTopics.slice(0,3).map((t,i)=>`${i+1}. ${t.Text||''}`).join('\n\n');
        }
        return `ğŸ” Searched for: "${query}" â€” no details found.`;
      }catch(e){ return 'âŒ Search failed. Check your internet connection.'; }
    }

    async function searchWikipedia(topic){
      try{
        const r = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(topic)}`);
        const d = await r.json();
        if(d.extract) return `ğŸ“š **${d.title}**\n\n${d.extract}\n\nğŸ”— https://en.wikipedia.org/wiki/${encodeURIComponent(d.title)}`;
        return `No article found for "${topic}".`;
      }catch(e){ return 'âŒ Wikipedia request failed.'; }
    }

    async function getWeather(city){
      if(!config.weatherKey) return 'ğŸŒ¤ï¸ Add a Weather API key in Settings for live forecasts.';
      try{
        const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${config.weatherKey}&units=metric`);
        const d = await r.json();
        if(d.cod!==200) return 'Weather lookup failed.';
        return `ğŸŒ¤ï¸ **${d.name}**: ${d.weather[0].description}, ${d.main.temp}Â°C (feels ${d.main.feels_like}Â°C)`;
      }catch(e){ return 'âŒ Weather fetch failed.'; }
    }

    async function getNews(topic){
      if(!config.newsKey) return 'ğŸ—ï¸ Add a News API key in Settings for headlines.';
      try{
        const r = await fetch(`https://newsapi.org/v2/everything?q=${encodeURIComponent(topic)}&pageSize=5&sortBy=publishedAt&apiKey=${config.newsKey}`);
        const d = await r.json();
        if(d.status!=='ok' || !d.articles?.length) return 'No news found.';
        return 'ğŸ—ï¸ **Top News**\n\n'+ d.articles.slice(0,3).map(a=>`â€¢ ${a.title} â€” ${a.source.name}`).join('\n');
      }catch(e){ return 'âŒ News fetch failed.'; }
    }

    async function convertCurrency(args){
      const m = args.match(/([\d.]+)\s*(\w+)\s*to\s*(\w+)/i);
      if(!m) return 'Usage: /currency 100 USD to EUR';
      const amt = parseFloat(m[1]); const from = m[2].toUpperCase(); const to = m[3].toUpperCase();
      try{
        const r = await fetch(`https://api.exchangerate.host/convert?from=${from}&to=${to}&amount=${amt}`);
        const d = await r.json();
        return `ğŸ’± ${amt} ${from} â‰ˆ ${d.result?.toFixed(2)} ${to}`;
      }catch(e){ return 'âŒ Currency convert failed.'; }
    }

    async function getDefinition(word){
      try{
        const r = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
        const d = await r.json();
        const first = d[0];
        if(!first) return 'No definition found.';
        const def = first.meanings?.[0]?.definitions?.[0]?.definition || 'â€”';
        return `ğŸ“– **${first.word}** â€” ${def}`;
      }catch(e){ return 'âŒ Dictionary lookup failed.'; }
    }

    async function translateText(args){
      const m = args.match(/(.+)\s+to\s+(\w+)/i);
      if(!m) return 'Usage: /translate [text] to [lang]';
      const text = m[1]; const lang = m[2];
      try{
        const r = await fetch('https://libretranslate.de/translate',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({q:text, source:'auto', target:lang}) });
        const d = await r.json();
        return `ğŸŒ ${d.translatedText}`;
      }catch(e){ return 'âŒ Translate failed.'; }
    }

    async function getTimeIn(city){
      if(!city || city.toUpperCase()==='UTC') return `â° ${new Date().toUTCString()}`;
      return `â° Time lookup for "${city}" not configured. Try /time UTC`;
    }

    // -------------------- UI helpers --------------------
    function addMessage(text, role='bot', quickReplies=[]){
      messages.push({ role, text });
      localStorage.setItem('messages', JSON.stringify(messages));
      const wrap = document.createElement('div');
      wrap.className = `max-w-3xl mx-auto ${role==='user'?'text-right':''}`;
      wrap.innerHTML = role==='user' ?
        `<div class="inline-block bg-indigo-600 text-white px-4 py-2 rounded-2xl shadow">${escapeHTML(text)}</div>` :
        `<div class="inline-block bg-white px-4 py-2 rounded-2xl shadow">${mdToHtml(text)}</div>`;
      const container = document.getElementById('messages');
      container.appendChild(wrap);
      if(quickReplies?.length){
        const row = document.createElement('div');
        row.className = 'max-w-3xl mx-auto flex gap-2 mt-2';
        quickReplies.forEach(q=>{
          const b = document.createElement('button');
          b.className = 'px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm';
          b.textContent = q; b.onclick = ()=>{ document.getElementById('input').value = q; send(); };
          row.appendChild(b);
        });
        container.appendChild(row);
      }
      container.scrollTop = container.scrollHeight;
    }

    function showTyping(){
      const el = document.createElement('div');
      el.id = 'typing';
      el.className = 'max-w-3xl mx-auto';
      el.innerHTML = `
        <div class='inline-flex items-center gap-1 bg-white px-4 py-2 rounded-2xl shadow'>
          <span class='typing-dot'>â€¢</span><span class='typing-dot'>â€¢</span><span class='typing-dot'>â€¢</span>
        </div>`;
      document.getElementById('messages').appendChild(el);
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }
    function hideTyping(){ const t = document.getElementById('typing'); if(t) t.remove(); }
    function getQuickReplies(){ return []; }

    function openSettings(){ document.getElementById('settingsModal').classList.remove('hidden'); }
    function closeSettings(){ document.getElementById('settingsModal').classList.add('hidden'); }
    function toggleAISettings(){
      const m = document.getElementById('aiMode').value;
      document.getElementById('geminiSettings').classList.toggle('hidden', m!=='gemini');
      document.getElementById('openaiSettings').classList.toggle('hidden', m!=='openai');
    }

    function saveSettings(){
      config.mode = document.getElementById('aiMode').value;
      config.geminiKey = document.getElementById('geminiKey').value.trim();
      config.openaiKey = document.getElementById('openaiKey').value.trim();
      config.weatherKey = document.getElementById('weatherKey').value.trim();
      config.newsKey = document.getElementById('newsKey').value.trim();
      config.autoSpeak = document.getElementById('autoSpeak').checked;
      config.continuousListen = document.getElementById('continuousListen').checked;
      config.voiceNum = parseInt(document.getElementById('voiceNum').value)||5;
      config.voiceSpeed = parseFloat(document.getElementById('voiceSpeed').value)||1.3;
      config.userName = document.getElementById('userName').value.trim();
      config.personality = document.getElementById('personality').value;
      localStorage.setItem('config', JSON.stringify(config));
      updateStatus();
      closeSettings();
      showToast('âœ… Settings saved');
    }

    function loadConfig(){
      try{ const raw = localStorage.getItem('config'); if(raw){ config = { ...config, ...JSON.parse(raw) }; }
      }catch(e){}
      // reflect in UI
      document.getElementById('aiMode').value = config.mode;
      document.getElementById('geminiKey').value = config.geminiKey;
      document.getElementById('openaiKey').value = config.openaiKey;
      document.getElementById('weatherKey').value = config.weatherKey;
      document.getElementById('newsKey').value = config.newsKey;
      document.getElementById('autoSpeak').checked = config.autoSpeak;
      document.getElementById('continuousListen').checked = config.continuousListen;
      document.getElementById('voiceNum').value = config.voiceNum;
      document.getElementById('voiceSpeed').value = config.voiceSpeed; document.getElementById('speedVal').textContent = config.voiceSpeed;
      document.getElementById('userName').value = config.userName;
      document.getElementById('personality').value = config.personality;
      toggleAISettings();
    }

    function loadMessages(){
      try{ const raw = localStorage.getItem('messages'); if(raw) messages = JSON.parse(raw) || []; }catch(e){}
      const container = document.getElementById('messages');
      container.innerHTML = '';
      if(messages.length===0){ // leave the welcome block
        container.innerHTML = container.innerHTML; return;
      }
      messages.forEach(m=> addMessage(m.text, m.role));
    }

    function clearChat(){ messages = []; localStorage.removeItem('messages'); document.getElementById('messages').innerHTML=''; showToast('ğŸ§¹ Cleared'); }

    function showCommands(){ addMessage('Type /help to see all commands.','bot'); }

    function showToast(msg){
      const t = document.createElement('div');
      t.className = 'fixed bottom-20 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg slide-in z-50';
      t.textContent = msg; document.body.appendChild(t); setTimeout(()=>t.remove(), 3000);
    }

    function quickAction(text){ document.getElementById('input').value = text; send(); }

    // -------------------- Utilities --------------------
    function escapeHTML(s){ return s.replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
    function mdToHtml(md){
      // tiny markdown: **bold**, \n -> <br>
      return escapeHTML(md).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');
    }
  </script>
</body>
</html>
